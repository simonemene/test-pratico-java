
CREATE TABLE RUOLO (
  ID           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  RUOLO        VARCHAR(50) NOT NULL,
  RUOLO_ID     VARCHAR(36) NOT NULL,

  CONSTRAINT UK_RUOLO_RUOLO    UNIQUE (RUOLO),
  CONSTRAINT UK_RUOLO_RUOLO_ID UNIQUE (RUOLO_ID)
);


CREATE TABLE UTENTE (
  ID                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  EMAIL              VARCHAR(255) NOT NULL,
  UTENTE_ID          VARCHAR(36)  NOT NULL,

  NOME               VARCHAR(255),
  COGNOME            VARCHAR(255),

  PASSWORD           VARCHAR(255) NOT NULL,

  CODICE_FISCALE     VARCHAR(255) NOT NULL,

  ID_RUOLO           BIGINT NOT NULL,

  VERSION            INTEGER NOT NULL,

  UTENTE_INS         VARCHAR(255),
  TIMESTAMP_INS      VARCHAR(255),
  UTENTE_MODIFICA    VARCHAR(255),
  TIMESTAMP_MODIFICA VARCHAR(255),
  FLG_ANNULLO        VARCHAR(1),

  CONSTRAINT UK_UTENTE_EMAIL          UNIQUE (EMAIL),
  CONSTRAINT UK_UTENTE_UTENTE_ID      UNIQUE (UTENTE_ID),
  CONSTRAINT UK_UTENTE_CODICE_FISCALE UNIQUE (CODICE_FISCALE),

  CONSTRAINT FK_UTENTE_RUOLO
    FOREIGN KEY (ID_RUOLO) REFERENCES RUOLO(ID)
);


CREATE TABLE PRODOTTO (
  ID                   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  ID_PUBBLICO_PRODOTTO VARCHAR(36) NOT NULL,
  PREZZO               DECIMAL(19, 2),
  VERSION              INTEGER NOT NULL,
  NOME                 VARCHAR(255),

  UTENTE_INS         VARCHAR(255),
  TIMESTAMP_INS      VARCHAR(255),
  UTENTE_MODIFICA    VARCHAR(255),
  TIMESTAMP_MODIFICA VARCHAR(255),
  FLG_ANNULLO        VARCHAR(1),

  CONSTRAINT UK_PRODOTTO_PUBLIC_ID UNIQUE (ID_PUBBLICO_PRODOTTO),
  CONSTRAINT UK_PRODOTTO_NOME      UNIQUE (NOME)
);

CREATE TABLE ORDINE (
  ID                   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  ORDINE_ID            VARCHAR(36) NOT NULL,
  ID_UTENTE            BIGINT NOT NULL,

  VERSION              INTEGER NOT NULL,

  STATO                VARCHAR(50),

  UTENTE_INS         VARCHAR(255),
  TIMESTAMP_INS      VARCHAR(255),
  UTENTE_MODIFICA    VARCHAR(255),
  TIMESTAMP_MODIFICA VARCHAR(255),
  FLG_ANNULLO        VARCHAR(1),

  CONSTRAINT UK_ORDINE_ORDINE_ID UNIQUE (ORDINE_ID),

  CONSTRAINT FK_ORDINE_UTENTE
    FOREIGN KEY (ID_UTENTE) REFERENCES UTENTE(ID)
);

CREATE TABLE STOCK (
  ID            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  QUANTITA      INTEGER,

  PRODOTTO_ID   BIGINT NOT NULL,

  UTENTE_INS         VARCHAR(255),
  TIMESTAMP_INS      VARCHAR(255),
  UTENTE_MODIFICA    VARCHAR(255),
  TIMESTAMP_MODIFICA VARCHAR(255),
  FLG_ANNULLO        VARCHAR(1),

  CONSTRAINT UK_STOCK_PRODOTTO UNIQUE (PRODOTTO_ID),

  CONSTRAINT FK_STOCK_PRODOTTO
    FOREIGN KEY (PRODOTTO_ID) REFERENCES PRODOTTO(ID)
);


CREATE TABLE MOVIMENTO (
  ID           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  ID_ORDINE    BIGINT NOT NULL,
  ID_PRODOTTO  BIGINT NOT NULL,

  QUANTITA     INTEGER NOT NULL,

  UTENTE_INS         VARCHAR(255),
  TIMESTAMP_INS      VARCHAR(255),
  UTENTE_MODIFICA    VARCHAR(255),
  TIMESTAMP_MODIFICA VARCHAR(255),
  FLG_ANNULLO        VARCHAR(1),

  CONSTRAINT movimento_ordine_prodotto UNIQUE (ID_ORDINE, ID_PRODOTTO),

  CONSTRAINT FK_MOVIMENTO_ORDINE
    FOREIGN KEY (ID_ORDINE) REFERENCES ORDINE(ID),

  CONSTRAINT FK_MOVIMENTO_PRODOTTO
    FOREIGN KEY (ID_PRODOTTO) REFERENCES PRODOTTO(ID)
);

--INDICI

CREATE INDEX IDX_UTENTE_ID_RUOLO    ON UTENTE(ID_RUOLO);
CREATE INDEX IDX_ORDINE_ID_UTENTE   ON ORDINE(ID_UTENTE);
CREATE INDEX IDX_MOV_ID_ORDINE      ON MOVIMENTO(ID_ORDINE);
CREATE INDEX IDX_MOV_ID_PRODOTTO    ON MOVIMENTO(ID_PRODOTTO);


--INSERT
INSERT INTO RUOLO (RUOLO, RUOLO_ID)
VALUES ('ROLE_USER',  'USER');

INSERT INTO RUOLO (RUOLO, RUOLO_ID)
VALUES ('ROLE_ADMIN', 'ADMIN');


INSERT INTO UTENTE (
  EMAIL,
  UTENTE_ID,
  NOME,
  COGNOME,
  PASSWORD,
  CODICE_FISCALE,
  ID_RUOLO,
  VERSION,
  FLG_ANNULLO
)
VALUES (
  'admin@test.it',
  'admin-utente-id',
  'Admin',
  'User',
  '{bcrypt}$2a$12$.XTNAhnp58JcIHdWRiueeeQv83YM.Z2n9VhunYSR2BztZL/x5v.1i',
  'ADMINCF123456789',
  (SELECT ID FROM RUOLO WHERE RUOLO = 'ROLE_ADMIN'),
  0,
  'N'
);
